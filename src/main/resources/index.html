<!DOCTYPE html>
<html>
  <head>
    <title>Shopping List</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css" />
    <script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
  </head>

  <body>

    <div data-role="page" data-theme="b">
      <div data-role="header">
        <h1>Shopping List</h1>
      </div>

      <div data-role="content">
        <div>
          <h1>Shopping List</h1>
          <div id="shopping-list" data-role="collapsible-set"></div>
        </div>
        <div>
          <h1>Recipe List</h1>
          <textarea name="recipelist" id="recipe-list"></textarea>
          <a class="generate" data-source="recipe-list" data-target="shopping-list" data-role="button">Generate shopping list</a>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      jQuery(document).bind('pageinit', function() {
        jQuery(".generate").bind("click", function() {
          var source = jQuery("#" + jQuery(this).attr("data-source"));
          var target = jQuery("#" + jQuery(this).attr("data-target"));

          jQuery.ajax({
            type: "POST",
            url: "/",
            headers: {
              "Accepts": "application/json",
              "Content-Type": "text/plain"
            },

            data: source.val(),

            success: function(data) {
              var unknown = [], groups = {};
              var groupFor = function(name) { return name ? (groups[name] = groups[name] || []) : unknown; }
              for (var i = 0; i < data.length; ++i) { groupFor(data[i].category).push(data[i]); }

              var groupHandler = function(items, groupName) {
                var html = '<div data-role="collapsible" data-content-theme="c"><h1>' + groupName + '</h1><fieldset data-role="controlgroup">';
                jQuery.each(items, function(index, item) {
                  var amount = item.amount || {quantity:'',units:''};
                  html += '<label><input type="checkbox" name="item-'+index+'"/><span class="quantity">' + amount.quantity + '' + amount.units + '</span> ' + item.line + '</label>';
                })
                html += '</fieldset></div>';
                return jQuery(html);
              }

              target.empty().append(groupHandler(unknown, "Unknown").attr('data-theme', 'a')).append(jQuery.map(groups, groupHandler)).trigger("create").collapsibleset("refresh");
            }
          });
        });
      });
    </script>
  </body>
</html>
